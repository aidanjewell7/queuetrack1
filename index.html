<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src https://fonts.gstatic.com; script-src 'self';">
    <title>QueueTrack</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-logo">QueueTrack</div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading your data...</div>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">QT</div>
            </div>
            <div class="sidebar-nav">
                <button class="sidebar-nav-item active" id="navHome" title="Home">
                    <span class="sidebar-icon">&#x1F3E0;</span>
                    <span class="sidebar-label">Home</span>
                </button>
                <button class="sidebar-nav-item" id="navSettings" title="Settings">
                    <span class="sidebar-icon">&#x2699;&#xFE0F;</span>
                    <span class="sidebar-label">Settings</span>
                </button>
            </div>
            <div class="sidebar-footer">
                <div class="mode-toggle-sidebar">
                    <button class="mode-btn active" id="lightBtn" title="Light Mode">&#x2600;&#xFE0F;</button>
                    <button class="mode-btn" id="darkBtn" title="Dark Mode">&#x1F319;</button>
                </div>
            </div>
        </nav>

        <div class="mockup">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="left-section">
                    <button class="back-btn" id="backBtn" style="display: none;">&#x2190;</button>
                    <div class="app-title" id="pageTitle">Home</div>
                    <div class="search-wrapper" id="searchWrapper">
                        <span class="search-icon">&#x1F50D;</span>
                        <input type="text" class="search-input" id="searchInput" placeholder="Search emails...">
                    </div>
                </div>
                <div class="right-section">
                    <button class="icon-btn" id="undoBtn" title="Undo" style="display: none;">&#x21B6;</button>
                    <button class="icon-btn" id="redoBtn" title="Redo" style="display: none;">&#x21B7;</button>
                    <button class="help-btn" id="helpBtn">Help</button>
                    <button class="import-btn" id="importBtn">Import CSV</button>
                </div>
            </div>

            <!-- Tools Bar (above data table) -->
            <div class="tools-bar" id="toolsBar">
                <div class="tools-left">
                    <button class="tool-btn" id="groupBtn" title="Manage Groups">
                        <span class="tool-icon">&#x1F465;</span>
                        <span class="tool-label">Groups</span>
                    </button>
                    <button class="tool-btn" id="compareBtn" title="Compare Accounts">
                        <span class="tool-icon">&#x1F4CA;</span>
                        <span class="tool-label">Compare</span>
                    </button>
                    <div class="compare-actions" id="compareActions" style="display: none;">
                        <button class="action-btn compare" id="runCompareBtn" disabled>Compare (0)</button>
                        <button class="action-btn cancel" id="cancelCompareBtn">Cancel</button>
                    </div>
                </div>
                <div class="tools-right">
                    <span class="tools-stats" id="toolsStats">0 accounts</span>
                </div>
            </div>

            <!-- Update Bar -->
            <div class="update-bar" id="updateBar" style="display: none;">
                <div class="update-bar-content">
                    <span class="update-bar-icon" id="updateIcon"></span>
                    <span class="update-bar-text" id="updateText"></span>
                    <div class="update-bar-progress" id="updateProgress" style="display: none;">
                        <div class="update-bar-progress-fill" id="updateProgressFill"></div>
                    </div>
                </div>
                <div class="update-bar-actions" id="updateActions"></div>
            </div>

            <!-- Main Content -->
            <div class="main-content" id="mainContent">
                <div class="stats-dashboard">
                    <div class="stat-card">
                        <div class="stat-label">Total Accounts</div>
                        <div class="stat-value" id="totalAccounts">0</div>
                    </div>
                    <div class="stat-card clickable" id="bestPositionCard">
                        <div class="stat-label">Best Position</div>
                        <div class="stat-value" id="bestPosition">&mdash;</div>
                    </div>
                </div>

                <div class="filter-chips">
                    <button class="filter-chip active" data-filter="all">All</button>
                    <button class="filter-chip" data-filter="instants">Instants</button>
                    <button class="filter-chip" data-filter="juice">Juice</button>
                    <button class="filter-chip" data-filter="excellent">Excellent</button>
                    <button class="filter-chip" data-filter="improving">Improving</button>
                    <button class="filter-chip" data-filter="declining">Declining</button>
                    <!-- Group filter chips are added dynamically -->
                </div>

                <div class="best-queues-strip" id="bestQueuesStrip" style="display: none;">
                    <div class="best-queues-label">BEST QUEUES</div>
                    <div class="best-queues-list" id="bestQueuesList"></div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort="email" style="min-width: 250px;">Email <span class="sort-indicator"></span></th>
                                <th class="sortable-header active" data-sort="change">Change % <span class="sort-indicator">&#x25BC;</span></th>
                                <th>Most Recent</th>
                                <th>-2</th>
                                <th>-3</th>
                                <th>-4</th>
                                <th>-5</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #86868b;">
                                    No data available. Import a CSV to get started!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Timeline Content -->
            <div class="timeline-page" id="timelinePage" style="display: none;">
                <div class="timeline-header">
                    <div class="timeline-email" id="timelineEmail">&mdash;</div>
                    <div class="timeline-subtitle" id="timelineSubtitle">&mdash;</div>
                </div>

                <div class="timeline-stats">
                    <div class="timeline-stat">
                        <div class="timeline-stat-label">Best Position</div>
                        <div class="timeline-stat-value" id="timelineBest">&mdash;</div>
                    </div>
                    <div class="timeline-stat">
                        <div class="timeline-stat-label">Worst Position</div>
                        <div class="timeline-stat-value" id="timelineWorst">&mdash;</div>
                    </div>
                    <div class="timeline-stat">
                        <div class="timeline-stat-label">Average</div>
                        <div class="timeline-stat-value" id="timelineAvg">&mdash;</div>
                    </div>
                    <div class="timeline-stat">
                        <div class="timeline-stat-label">Total Tests</div>
                        <div class="timeline-stat-value" id="timelineTotal">&mdash;</div>
                    </div>
                </div>

                <div class="graph-container">
                    <div class="graph-canvas">
                        <div class="y-axis">
                            <div class="y-label">0%</div>
                            <div class="y-label">25%</div>
                            <div class="y-label">50%</div>
                            <div class="y-label">75%</div>
                            <div class="y-label">100%</div>
                        </div>

                        <div class="grid-lines">
                            <div class="grid-line" style="top: 0%;"></div>
                            <div class="grid-line" style="top: 25%;"></div>
                            <div class="grid-line" style="top: 50%;"></div>
                            <div class="grid-line" style="top: 75%;"></div>
                            <div class="grid-line" style="top: 100%;"></div>
                        </div>

                        <div class="graph-area" id="graphArea">
                            <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <polyline class="graph-line" id="graphLine" points="" vector-effect="non-scaling-stroke" />
                            </svg>
                        </div>

                        <div class="x-axis" id="xAxis"></div>
                    </div>

                    <div class="point-tooltip" id="pointTooltip">
                        <div class="tooltip-row">
                            <span class="tooltip-label">Test #:</span>
                            <span class="tooltip-value" id="tooltipTest">&mdash;</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Date:</span>
                            <span class="tooltip-value" id="tooltipDate">&mdash;</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Queue:</span>
                            <span class="tooltip-value" id="tooltipQueue">&mdash;</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Queue %:</span>
                            <span class="tooltip-value" id="tooltipPercent">&mdash;</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Change:</span>
                            <span class="tooltip-value" id="tooltipChange">&mdash;</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Page -->
            <div class="comparison-page" id="comparisonPage" style="display: none;">
                <div class="comparison-header">
                    <div class="comparison-title">Account Comparison</div>
                </div>
                <div class="comparison-content" id="comparisonContent">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Settings Page (Full Page) -->
            <div class="settings-page" id="settingsPage" style="display: none;">
                <div class="settings-page-content">
                    <div class="settings-grid">
                        <div class="settings-card">
                            <div class="settings-card-title">Display</div>
                            <div class="setting-item">
                                <label class="setting-label">Row Size</label>
                                <select class="setting-input" id="rowSizeSelect">
                                    <option value="ultra-compact">Ultra-Compact</option>
                                    <option value="compact">Compact</option>
                                    <option value="normal" selected>Normal</option>
                                    <option value="comfortable">Comfortable</option>
                                </select>
                                <div class="setting-description">Adjust row height to see more or fewer accounts</div>
                            </div>
                        </div>

                        <div class="settings-card">
                            <div class="settings-card-title">Data Management</div>
                            <div style="font-size: 13px; color: #86868b; margin-bottom: 16px;">
                                <span id="dataStats">0 accounts, 0 tests</span>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="action-btn" id="viewImportsBtn">View Imports</button>
                                <button class="action-btn danger-btn" id="clearAllDataBtn">Clear All Data</button>
                            </div>
                        </div>

                        <div class="settings-card">
                            <div class="settings-card-title">About</div>
                            <div style="font-size: 14px; color: #1d1d1f; margin-bottom: 12px;">
                                QueueTrack <span id="appVersion" style="color: #86868b;">v1.0.0</span>
                            </div>
                            <button class="action-btn" id="checkUpdatesBtn">Check for Updates</button>
                        </div>

                        <div class="settings-card">
                            <div class="settings-card-title">Keyboard Shortcuts</div>
                            <div class="shortcuts-list">
                                <div class="shortcut-row"><kbd>Ctrl/Cmd + I</kbd> <span>Import CSV</span></div>
                                <div class="shortcut-row"><kbd>Ctrl/Cmd + Z</kbd> <span>Undo</span></div>
                                <div class="shortcut-row"><kbd>Ctrl/Cmd + Shift + Z</kbd> <span>Redo</span></div>
                                <div class="shortcut-row"><kbd>Ctrl/Cmd + F</kbd> <span>Search</span></div>
                                <div class="shortcut-row"><kbd>Escape</kbd> <span>Close panels</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Details Modal -->
    <div class="modal-overlay" id="testModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Test Details</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="testModalOkBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Group Manager Modal -->
    <div class="modal-overlay" id="groupModal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3 class="modal-title">Account Groups</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="group-create-row">
                    <input type="text" class="group-create-input" id="newGroupName" placeholder="New group name...">
                    <button class="modal-btn" id="createGroupBtn">Create Group</button>
                </div>
                <div class="group-list" id="groupList">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Import History Modal -->
    <div class="modal-overlay" id="importHistoryModal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3 class="modal-title">Import History</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="import-history-list" id="importHistoryList">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">Confirm</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="font-size: 14px; color: #48484a; line-height: 1.6;"></p>
            </div>
            <div class="modal-footer" style="gap: 8px;">
                <button class="action-btn" id="confirmCancelBtn">Cancel</button>
                <button class="action-btn danger-btn" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-overlay-content">
            <div class="loading-spinner"></div>
            <div class="loading-overlay-text" id="loadingOverlayText">Loading...</div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3 class="modal-title">Help &amp; Guide</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body help-body">
                <div class="help-section">
                    <div class="help-section-title">How to Import Data</div>
                    <div class="help-text">
                        1. Click <strong>Import CSV</strong> or press <strong>Ctrl/Cmd + I</strong><br>
                        2. Select your CSV file from the file picker<br>
                        3. Your data will be validated and imported automatically<br>
                        4. You can import multiple files &mdash; data accumulates across imports
                    </div>
                </div>

                <div class="help-section">
                    <div class="help-section-title">Required CSV Format</div>
                    <div class="help-text">
                        Your CSV must have these columns (case-sensitive):<br><br>
                        <code class="help-code">Email, Testing Date, Event Name, Queue Number, Queue Anchor</code><br><br>
                        <strong>Example rows:</strong><br>
                        <code class="help-code">
                            Email,Testing Date,Event Name,Queue Number,Queue Anchor<br>
                            user@email.com,2025-01-15,Taylor Swift Tour,150,5000<br>
                            user@email.com,2025-02-01,Taylor Swift Tour,80,5000
                        </code>
                    </div>
                </div>

                <div class="help-section">
                    <div class="help-section-title">Column Details</div>
                    <div class="help-text">
                        <strong>Email</strong> &mdash; Account email address (must be valid format)<br>
                        <strong>Testing Date</strong> &mdash; Date in most common formats (YYYY-MM-DD, MM/DD/YYYY, DD-MM-YYYY, etc.)<br>
                        <strong>Event Name</strong> &mdash; Name of the event (max 200 characters)<br>
                        <strong>Queue Number</strong> &mdash; Your position in queue (whole number)<br>
                        <strong>Queue Anchor</strong> &mdash; Total queue size (optional &mdash; auto-calculated if missing)
                    </div>
                </div>

                <div class="help-section">
                    <div class="help-section-title">Common Errors</div>
                    <div class="help-text">
                        <strong>"Missing required column"</strong> &mdash; Column names are case-sensitive. Make sure they match exactly: Email, Testing Date, Event Name, Queue Number<br><br>
                        <strong>"Invalid date"</strong> &mdash; Check date formatting. Supported: YYYY-MM-DD, MM/DD/YYYY, DD-MM-YYYY, DD.MM.YYYY, M/D/YY<br><br>
                        <strong>"Invalid email"</strong> &mdash; Check for typos or extra spaces in email addresses<br><br>
                        <strong>"Queue anchor less than queue number"</strong> &mdash; The anchor (total queue size) should be larger than your position number<br><br>
                        <strong>"File too large"</strong> &mdash; Maximum file size is 50MB
                    </div>
                </div>

                <div class="help-section">
                    <div class="help-section-title">Understanding Queue %</div>
                    <div class="help-text">
                        Queue % = (Queue Number / Queue Anchor) &times; 100<br><br>
                        <strong>Lower is better:</strong><br>
                        &bull; <strong>Instants</strong> (&le;1%) &mdash; Almost instant entry<br>
                        &bull; <strong>Juice</strong> (&le;10%) &mdash; Very strong position<br>
                        &bull; <strong>Excellent</strong> (10-20%) &mdash; Great position<br>
                        &bull; <strong>Good</strong> (20-40%) &mdash; Solid position<br>
                        &bull; <strong>Neutral</strong> (40-60%) &mdash; Average<br>
                        &bull; <strong>Poor</strong> (60%+) &mdash; Back of the queue
                    </div>
                </div>

                <div class="help-section">
                    <div class="help-section-title">Features</div>
                    <div class="help-text">
                        <strong>Compare</strong> &mdash; Select multiple accounts and view side-by-side stats and graphs<br>
                        <strong>Groups</strong> &mdash; Organize accounts into named groups and filter by group<br>
                        <strong>Timeline</strong> &mdash; Click "Timeline" on any account to see their full history graph<br>
                        <strong>Row Size</strong> &mdash; Adjust in Settings to show more or fewer rows on screen<br>
                        <strong>Undo/Redo</strong> &mdash; Revert imports with Ctrl+Z (up to 20 steps)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="node_modules/papaparse/papaparse.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
